import"./style-ETqBUHLR.js";document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("toggleButton"),t=localStorage.getItem("deliveryPersonId");e.addEventListener("click",async function(){try{const r=await fetch(`https://sosika-backend.onrender.com/api/deliveryPerson/${t}/toggle-active`,{method:"PUT",headers:{"Content-Type":"application/json"}}),o=await r.json();r.ok?(e.textContent=o.is_active?"Go Offline":"Go Online",e.classList.toggle("active",o.is_active),console.log("Updated status:",o.is_active)):console.error("Error:",o.message)}catch(r){console.error("Failed to toggle status:",r)}})});const i=io("https://sosika-backend.onrender.com"),p=localStorage.getItem("deliveryPersonId");let a,d=null,l=null;console.log(p);i.emit("joinDelivery",p);function h(e){document.getElementById("orderNumber").textContent=e.orderId,document.getElementById("orderNotification").style.display="block"}i.on("newOrderAvailable",e=>{console.log("New order received:",e),a=e,h(e)});window.acceptOrder=function(){console.log("Order accepted"),document.getElementById("btn-acc-dec").style.display="none",document.getElementById("btn-acc-dec2").style.display="none",document.getElementById("btn-acc-dec3").style.display="none",i.emit("acceptOrder",{orderId:a.orderId,deliveryPersonId:p}),fetch(`https://sosika-backend.onrender.com/api/orders/${a.orderId}/accept`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({delivery_person_id:p})}).then(e=>e.json().then(t=>({status:e.status,body:t}))).then(({status:e,body:t})=>{e===400?alert(t.error):e===404?alert("Order not found. It may have been assigned to another delivery person."):(console.log("Order accepted:",t),localStorage.setItem("assignedOrder",JSON.stringify(a)),f(a.pickup_location,a.dropoff_location))}).catch(e=>console.error("Error:",e))};const m=document.createElement("div");m.innerHTML='<div style="background-color: green; color: white; padding: 5px; border-radius: 50px; font-size: 12px; text-align: center; width: max-content;">Pick Up</div>';const y=document.createElement("div");y.innerHTML='<div style="background-color: Red; color: white; padding: 5px; border-radius: 50px; font-size: 12px; text-align: center; width: max-content;">Drop</div>';function f(e,t){u();const[r,o]=e.replace(/[()]/g,"").split(",").map(Number),[n,c]=t.replace(/[()]/g,"").split(",").map(Number);d=new mapboxgl.Marker({element:m}).setLngLat([o,r]).setPopup(new mapboxgl.Popup().setText("Pickup location")).addTo(s),l=new mapboxgl.Marker({element:y}).setLngLat([c,n]).setPopup(new mapboxgl.Popup().setText("Dropoff location")).addTo(s);const g=new mapboxgl.LngLatBounds;g.extend([o,r]),g.extend([c,n]),s.fitBounds(g,{padding:20}),b({x:r,y:o},{x:n,y:c})}function v(){s.getLayer("route")&&s.removeLayer("route"),s.getSource("route")&&s.removeSource("route")}function u(){d&&(d.remove(),d=null),l&&(l.remove(),l=null),v()}function b(e,t){const r=`https://api.mapbox.com/directions/v5/mapbox/driving/${e.x},${e.y};${t.x},${t.y}?geometries=geojson&access_token=${mapboxgl.accessToken}`;fetch(r).then(o=>{if(!o.ok)throw new Error(`HTTP Error: ${o.status}`);return o.json()}).then(o=>{if(console.log("API Response:",o),!o.routes||o.routes.length===0)throw new Error("No route found in response.");const n=o.routes[0].geometry;if(console.log("Extracted Route Geometry:",n),!n)throw new Error("Route geometry is missing.");s.getSource("route")?s.getSource("route").setData({type:"Feature",properties:{},geometry:n}):(s.addSource("route",{type:"geojson",data:{type:"Feature",properties:{},geometry:n}}),s.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#1DB954","line-width":5,"line-opacity":.8}}))}).catch(o=>console.error("Error fetching route:",o))}i.on("orderAssigned",e=>{console.log("New Order Assigned:",e),alert(`New order available: ${e.orderId}`)});i.on("orderCompleted",e=>{console.log("Order Completed:",e),alert(`Order ${e.orderId} is marked as completed.`)});document.addEventListener("DOMContentLoaded",function(){async function e(){const t=localStorage.getItem("assignedOrder");if(console.log(t),t){let r=JSON.parse(t);try{console.log(r);const n=await(await fetch(`https://sosika-backend.onrender.com/api/orders/${r.orderId}`)).json();console.log(n),n.message==="Order not found"?console.log("Order not found"):n.order_status==="completed"?(console.log("Order completed. Removing from localStorage."),u(),localStorage.removeItem("assignedOrder"),location.reload()):n.order_status==="in_progress"?(console.log("Order status changed back to 'in_progress'. Alerting delivery person."),alert("Order status changed back to 'In-Progress'. Please check your assigned orders."),u(),localStorage.removeItem("assignedOrder"),location.reload()):(console.log("Restoring assigned order:",r),f(n.pickup_location,n.dropoff_location))}catch(o){console.error("Error fetching order status:",o)}}}e(),setInterval(e,1e4)});mapboxgl.accessToken="pk.eyJ1IjoiLS11bHJpa2siLCJhIjoiY203YzV5dHIyMGY3NjJqc2Q5MmpxNm4ycCJ9.TilyKOmKcw2ekL2PY8Xofw";const s=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v11",center:[34.888822,-6.369028],zoom:5}),k=new mapboxgl.Marker().setLngLat([0,0]).addTo(s);function w(e){const t=e.coords.longitude,r=e.coords.latitude;k.setLngLat([t,r]),s.setCenter([t,r])}navigator.geolocation?navigator.geolocation.watchPosition(w,e=>console.log("Geolocation error:",e),{enableHighAccuracy:!0}):alert("Geolocation is not supported by your browser.");async function x(){if(!navigator.geolocation){console.error("Geolocation is not supported by this browser.");return}navigator.geolocation.getCurrentPosition(async e=>{const t=e.coords.latitude,r=e.coords.longitude,o=localStorage.getItem("deliveryPersonId");try{const c=await(await fetch(`https://sosika-backend.onrender.com/api/deliveryPerson/update-location/${o}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({latitude:t,longitude:r})})).json();console.log("Location updated:",c)}catch(n){console.error("Error updating location:",n)}},e=>{console.error("Error fetching location:",e)})}setInterval(x,1e4);
