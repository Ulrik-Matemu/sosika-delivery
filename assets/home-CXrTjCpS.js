import"./style-ETqBUHLR.js";const c=io("http://localhost:3000"),d=localStorage.getItem("deliveryPersonId");let a=null,l=null;console.log(d);c.emit("joinDelivery",d);function m(e){document.getElementById("orderNumber").textContent=e.orderId,document.getElementById("orderNotification").style.display="block"}c.on("newOrderAvailable",e=>{console.log("New order received:",e),m(e)});const g=document.createElement("div");g.innerHTML='<div style="background-color: green; color: white; padding: 5px; border-radius: 50px; font-size: 12px; text-align: center; width: max-content;">Pick Up</div>';const u=document.createElement("div");u.innerHTML='<div style="background-color: Red; color: white; padding: 5px; border-radius: 50px; font-size: 12px; text-align: center; width: max-content;">Drop</div>';function y(e,t){i(),a=new mapboxgl.Marker({element:g}).setLngLat([e.y,e.x]).setPopup(new mapboxgl.Popup().setText("Pickup location")).addTo(n),l=new mapboxgl.Marker({element:u}).setLngLat([t.x,t.y]).setPopup(new mapboxgl.Popup().setText("Dropoff location")).addTo(n);const o=new mapboxgl.LngLatBounds;o.extend([e.y,e.x]),o.extend([t.x,t.y]),n.fitBounds(o,{padding:20}),f(e,t)}function v(){n.getLayer("route")&&n.removeLayer("route"),n.getSource("route")&&n.removeSource("route")}function i(){a&&(a.remove(),a=null),l&&(l.remove(),l=null),v()}function f(e,t){const o=`https://api.mapbox.com/directions/v5/mapbox/driving/${e.y},${e.x};${t.x},${t.y}?geometries=geojson&access_token=${mapboxgl.accessToken}`;fetch(o).then(r=>r.json()).then(r=>{const s=r.routes[0].geometry;n.getSource("route")?n.getSource("route").setData({type:"Feature",properties:{},geometry:s}):n.addLayer({id:"route",type:"line",source:{type:"geojson",data:{type:"Feature",properties:{},geometry:s}},layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#1DB954","line-width":5,"line-opacity":.8}})}).catch(r=>console.log("Error fetching route:",r))}c.on("orderAssigned",e=>{console.log("New Order Assigned:",e),alert(`New order available: ${e.orderId}`)});c.on("orderCompleted",e=>{console.log("Order Completed:",e),alert(`Order ${e.orderId} is marked as completed.`)});document.addEventListener("DOMContentLoaded",function(){async function e(){const t=localStorage.getItem("assignedOrder");if(console.log(t),t){let o=JSON.parse(t);try{console.log(o);const s=await(await fetch(`http://localhost:3000/api/orders/${o.orderId}`)).json();console.log(s),s.message==="Order not found"?console.log("Order not found"):s.order_status==="completed"?(console.log("Order completed. Removing from localStorage."),i(),localStorage.removeItem("assignedOrder"),location.reload()):s.order_status==="in_progress"?(console.log("Order status changed back to 'in_progress'. Alerting delivery person."),alert("Order status changed back to 'In-Progress'. Please check your assigned orders."),i(),localStorage.removeItem("assignedOrder"),location.reload()):(console.log("Restoring assigned order:",o),y(o.pickup_location,o.dropoff_location))}catch(r){console.error("Error fetching order status:",r)}}}e(),setInterval(e,1e4)});mapboxgl.accessToken="pk.eyJ1IjoiLS11bHJpa2siLCJhIjoiY203YzV5dHIyMGY3NjJqc2Q5MmpxNm4ycCJ9.TilyKOmKcw2ekL2PY8Xofw";const n=new mapboxgl.Map({container:"map",style:"mapbox://styles/mapbox/streets-v11",center:[34.888822,-6.369028],zoom:5}),h=new mapboxgl.Marker().setLngLat([0,0]).addTo(n);function x(e){const t=e.coords.longitude,o=e.coords.latitude;h.setLngLat([t,o]),n.setCenter([t,o])}navigator.geolocation?navigator.geolocation.watchPosition(x,e=>console.log("Geolocation error:",e),{enableHighAccuracy:!0}):alert("Geolocation is not supported by your browser.");async function b(){if(!navigator.geolocation){console.error("Geolocation is not supported by this browser.");return}navigator.geolocation.getCurrentPosition(async e=>{const t=e.coords.latitude,o=e.coords.longitude,r=localStorage.getItem("deliveryPersonId");try{const p=await(await fetch(`http://localhost:3000/api/deliveryPerson/update-location/${r}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({latitude:t,longitude:o})})).json();console.log("Location updated:",p)}catch(s){console.error("Error updating location:",s)}},e=>{console.error("Error fetching location:",e)})}setInterval(b,1e4);document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("toggleButton"),t=localStorage.getItem("deliveryPersonId");e.addEventListener("click",async function(){try{const o=await fetch(`http://localhost:3000/api/deliveryPerson/${t}/toggle-active`,{method:"PUT",headers:{"Content-Type":"application/json"}}),r=await o.json();o.ok?(e.textContent=r.is_active?"Go Offline":"Go Online",e.classList.toggle("active",r.is_active),console.log("Updated status:",r.is_active)):console.error("Error:",r.message)}catch(o){console.error("Failed to toggle status:",o)}})});
